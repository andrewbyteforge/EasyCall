{% extends 'base.html' %}

{% block title %}Add API Provider - EasyCall{% endblock %}

{% block content %}
<!-- Hero Section - matching home page style -->
<section class="hero-section">
    <div class="container">
        <div class="hero-badge">
            <i class="bi bi-cloud-arrow-up-fill"></i>
            Add API Provider
        </div>
        <h1 class="hero-title">Upload OpenAPI<br>Specification</h1>
        <p class="hero-subtitle">
            Add a new blockchain intelligence provider by uploading its OpenAPI spec.
            We'll automatically generate workflow nodes from the API endpoints.
        </p>
    </div>
</section>

<!-- Upload Section -->
<section class="actions-section">
    <div class="container" style="max-width: 900px;">
        
        <!-- Step Indicator -->
        <div class="step-progress" style="margin-bottom: 3rem;">
            <div class="steps-container">
                <div class="step active" id="step-1">
                    <div class="step-number">1</div>
                    <div class="step-label">Upload Spec</div>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step-2">
                    <div class="step-number">2</div>
                    <div class="step-label">Parse</div>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step-3">
                    <div class="step-number">3</div>
                    <div class="step-label">Generate Nodes</div>
                </div>
            </div>
        </div>

        <!-- Upload Card -->
        <div class="upload-card">
            
            <!-- Alerts -->
            <div id="alert-success" class="alert-message success" style="display: none;">
                <i class="bi bi-check-circle-fill"></i>
                <span id="success-message"></span>
            </div>
            
            <div id="alert-error" class="alert-message error" style="display: none;">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span id="error-message"></span>
            </div>
            
            <!-- Upload Form -->
            <form id="upload-form" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Provider Name -->
                <div class="form-field">
                    <label class="field-label">
                        Provider Name <span style="color: var(--accent-color);">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="provider-name" 
                        name="provider"
                        class="field-input" 
                        placeholder="e.g., trm_labs, chainalysis, elliptic"
                        required
                        pattern="[a-z0-9_]+"
                    >
                    <small class="field-hint">Lowercase letters, numbers, and underscores only</small>
                </div>
                
                <!-- File Upload -->
                <div class="form-field">
                    <label class="field-label">
                        OpenAPI Specification File <span style="color: var(--accent-color);">*</span>
                    </label>
                    
                    <div class="upload-zone" id="upload-zone">
                        <input 
                            type="file" 
                            id="spec-file" 
                            name="spec_file"
                            accept=".json,.yaml,.yml"
                            style="display: none;"
                            required
                        >
                        
                        <div id="upload-prompt">
                            <div class="upload-icon">
                                <i class="bi bi-cloud-arrow-up"></i>
                            </div>
                            <div class="upload-text">Click to browse or drag and drop</div>
                            <div class="upload-hint">Supports .json, .yaml, and .yml files (max 10MB)</div>
                        </div>
                        
                        <div class="file-selected" id="file-info" style="display: none;">
                            <i class="bi bi-file-earmark-check-fill"></i>
                            <div class="file-details">
                                <div class="file-name" id="file-name"></div>
                                <div class="file-size" id="file-size"></div>
                            </div>
                            <button type="button" class="btn-remove" onclick="removeFile()">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="progress-container" id="progress-container" style="display: none;">
                        <div class="progress-bar" id="progress-bar"></div>
                        <div class="progress-text" id="progress-text">Uploading...</div>
                    </div>
                </div>
                
                <!-- Active Checkbox -->
                <div class="form-field">
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            id="is-active" 
                            name="is_active"
                            checked
                        >
                        <span>Activate provider immediately after upload</span>
                    </label>
                </div>
                
                <!-- Loading State -->
                <div id="loading-state" class="loading-state" style="display: none;">
                    <div class="spinner"></div>
                    <p id="loading-text">Processing...</p>
                </div>
                
                <!-- Action Buttons -->
                <div class="form-actions">
                    <a href="/" class="btn-secondary">
                        <i class="bi bi-arrow-left"></i>
                        Back to Home
                    </a>
                    <button type="submit" class="btn-primary" id="submit-btn">
                        <i class="bi bi-cloud-arrow-up-fill"></i>
                        Upload & Generate Nodes
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

<style>
    /* Step Progress */
    .step-progress {
        padding: 2rem 0;
    }
    
    .steps-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0;
    }
    
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }
    
    .step-number {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: var(--text-secondary);
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    
    .step.active .step-number {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
        box-shadow: 0 4px 15px rgba(var(--accent-rgb), 0.5);
    }
    
    .step.completed .step-number {
        background: var(--success-color);
        border-color: var(--success-color);
        color: white;
    }
    
    .step.completed .step-number::after {
        content: 'âœ“';
    }
    
    .step-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        font-weight: 500;
    }
    
    .step.active .step-label {
        color: var(--accent-color);
        font-weight: 600;
    }
    
    .step-line {
        width: 80px;
        height: 2px;
        background: rgba(255, 255, 255, 0.1);
        margin: 0 1rem;
        position: relative;
        top: -12px;
    }
    
    /* Upload Card */
    .upload-card {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1rem;
        padding: 2.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    /* Form Fields */
    .form-field {
        margin-bottom: 2rem;
    }
    
    .field-label {
        display: block;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
        font-weight: 600;
        font-size: 1rem;
    }
    
    .field-input {
        width: 100%;
        padding: 0.875rem 1.25rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 0.5rem;
        color: white;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .field-input:focus {
        outline: none;
        border-color: var(--accent-color);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.1);
    }
    
    .field-input::placeholder {
        color: rgba(255, 255, 255, 0.3);
    }
    
    .field-hint {
        display: block;
        margin-top: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }
    
    /* Upload Zone */
    .upload-zone {
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: 0.75rem;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.02);
    }
    
    .upload-zone:hover {
        border-color: var(--accent-color);
        background: rgba(var(--accent-rgb), 0.05);
    }
    
    .upload-zone.dragover {
        border-color: var(--accent-color);
        background: rgba(var(--accent-rgb), 0.1);
        transform: scale(1.01);
    }
    
    .upload-zone.has-file {
        border-color: var(--success-color);
        background: rgba(var(--success-rgb), 0.05);
        border-style: solid;
    }
    
    .upload-icon {
        font-size: 3.5rem;
        color: var(--accent-color);
        margin-bottom: 1rem;
    }
    
    .upload-text {
        color: var(--text-primary);
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .upload-hint {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .file-selected {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1.5rem;
        background: rgba(var(--success-rgb), 0.1);
        border: 1px solid rgba(var(--success-rgb), 0.3);
        border-radius: 0.75rem;
    }
    
    .file-selected i {
        font-size: 2.5rem;
        color: var(--success-color);
    }
    
    .file-details {
        flex: 1;
        text-align: left;
    }
    
    .file-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }
    
    .file-size {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    
    .btn-remove {
        background: rgba(var(--error-rgb), 0.2);
        border: 1px solid rgba(var(--error-rgb), 0.3);
        color: var(--error-color);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }
    
    .btn-remove:hover {
        background: rgba(var(--error-rgb), 0.3);
    }
    
    /* Checkbox */
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        color: var(--text-primary);
        font-weight: 500;
    }
    
    .checkbox-label input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    /* Alert Messages */
    .alert-message {
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        font-weight: 500;
    }
    
    .alert-message i {
        font-size: 1.5rem;
    }
    
    .alert-message.success {
        background: rgba(var(--success-rgb), 0.1);
        border: 1px solid rgba(var(--success-rgb), 0.3);
        color: var(--success-color);
    }
    
    .alert-message.error {
        background: rgba(var(--error-rgb), 0.1);
        border: 1px solid rgba(var(--error-rgb), 0.3);
        color: var(--error-color);
    }
    
    /* Progress */
    .progress-container {
        margin-top: 1.5rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 0.5rem;
    }
    
    .progress-bar {
        width: 0%;
        height: 8px;
        background: linear-gradient(90deg, var(--accent-color), var(--primary-color));
        border-radius: 4px;
        transition: width 0.3s ease;
        margin-bottom: 0.5rem;
    }
    
    .progress-text {
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    /* Loading State */
    .loading-state {
        text-align: center;
        padding: 2rem;
    }
    
    .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid var(--accent-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-state p {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin: 0;
    }
    
    /* Form Actions */
    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2.5rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .btn-secondary {
        background: rgba(255, 255, 255, 0.05);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 0.875rem 2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
        color: white;
        border: none;
        padding: 0.875rem 2.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(var(--accent-rgb), 0.4);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(var(--accent-rgb), 0.6);
    }
    
    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// CSRF Token
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Elements
const uploadZone = document.getElementById('upload-zone');
const fileInput = document.getElementById('spec-file');
const uploadForm = document.getElementById('upload-form');
const submitBtn = document.getElementById('submit-btn');
const fileInfo = document.getElementById('file-info');
const uploadPrompt = document.getElementById('upload-prompt');
const progressContainer = document.getElementById('progress-container');
const progressBar = document.getElementById('progress-bar');
const progressText = document.getElementById('progress-text');
const loadingState = document.getElementById('loading-state');
const loadingText = document.getElementById('loading-text');

// Alerts
const alertSuccess = document.getElementById('alert-success');
const alertError = document.getElementById('alert-error');

// Steps
const step1 = document.getElementById('step-1');
const step2 = document.getElementById('step-2');
const step3 = document.getElementById('step-3');

// Click to upload
uploadZone.addEventListener('click', (e) => {
    if (e.target.classList.contains('btn-remove')) return;
    fileInput.click();
});

// File selection
fileInput.addEventListener('change', (e) => {
    handleFile(e.target.files[0]);
});

// Drag and drop
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    handleFile(e.dataTransfer.files[0]);
});

// Handle file
function handleFile(file) {
    if (!file) return;
    
    // Validate file type
    const validExtensions = ['.json', '.yaml', '.yml'];
    const fileName = file.name.toLowerCase();
    const isValid = validExtensions.some(ext => fileName.endsWith(ext));
    
    if (!isValid) {
        showAlert('error', 'Please upload a valid OpenAPI spec file (.json, .yaml, or .yml)');
        return;
    }
    
    // Validate file size (10MB max)
    if (file.size > 10 * 1024 * 1024) {
        showAlert('error', 'File size must be less than 10MB');
        return;
    }
    
    // Update file input
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(file);
    fileInput.files = dataTransfer.files;
    
    // Show file info
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = formatFileSize(file.size);
    uploadPrompt.style.display = 'none';
    fileInfo.style.display = 'flex';
    uploadZone.classList.add('has-file');
    
    // Auto-fill provider name if empty
    const providerInput = document.getElementById('provider-name');
    if (!providerInput.value) {
        const baseName = file.name.replace(/\.(json|yaml|yml)$/i, '');
        providerInput.value = baseName.replace(/[^a-z0-9_]/gi, '_').toLowerCase();
    }
    
    // Hide alerts
    alertSuccess.style.display = 'none';
    alertError.style.display = 'none';
}

// Remove file
function removeFile() {
    fileInput.value = '';
    uploadPrompt.style.display = 'block';
    fileInfo.style.display = 'none';
    uploadZone.classList.remove('has-file');
}

// Format file size
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
    else return (bytes / 1048576).toFixed(2) + ' MB';
}

// Show alert
function showAlert(type, message) {
    alertSuccess.style.display = 'none';
    alertError.style.display = 'none';
    
    if (type === 'success') {
        document.getElementById('success-message').textContent = message;
        alertSuccess.style.display = 'flex';
    } else if (type === 'error') {
        document.getElementById('error-message').textContent = message;
        alertError.style.display = 'flex';
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Update step
function updateStep(stepNumber) {
    [step1, step2, step3].forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index < stepNumber - 1) {
            step.classList.add('completed');
            step.querySelector('.step-number').textContent = '';
        } else if (index === stepNumber - 1) {
            step.classList.add('active');
        }
    });
}

// Form submission
uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Hide alerts
    alertSuccess.style.display = 'none';
    alertError.style.display = 'none';
    
    // Show loading
    submitBtn.disabled = true;
    loadingState.style.display = 'block';
    progressContainer.style.display = 'block';
    progressBar.style.width = '10%';
    
    try {
        const formData = new FormData(uploadForm);
        
        // Step 1: Upload
        updateStep(1);
        loadingText.textContent = 'Uploading specification...';
        progressBar.style.width = '30%';
        progressText.textContent = 'Uploading...';
        
        const uploadResponse = await fetch('/api/v1/integrations/specs/', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            body: formData
        });
        
        if (!uploadResponse.ok) {
            const error = await uploadResponse.json();
            throw new Error(error.message || 'Upload failed');
        }
        
        const uploadData = await uploadResponse.json();
        console.log('Upload response:', uploadData);  // Debug
        const specId = uploadData.uuid || uploadData.id;  // Try both
        
        // Step 2: Parse
        updateStep(2);
        loadingText.textContent = 'Parsing specification...';
        progressBar.style.width = '60%';
        progressText.textContent = 'Parsing...';
        
        const parseResponse = await fetch(`/api/v1/integrations/specs/${specId}/parse/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        });
        
        if (!parseResponse.ok) {
            throw new Error('Parsing failed');
        }
        
        // Step 3: Generate Nodes
        updateStep(3);
        loadingText.textContent = 'Generating workflow nodes...';
        progressBar.style.width = '90%';
        progressText.textContent = 'Generating nodes...';
        
        const generateResponse = await fetch(`/api/v1/integrations/specs/${specId}/generate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        });
        
        if (!generateResponse.ok) {
            throw new Error('Node generation failed');
        }
        
        const generateData = await generateResponse.json();
        
        // Success!
        progressBar.style.width = '100%';
        progressText.textContent = 'Complete!';
        step3.classList.add('completed');
        
        const nodeCount = generateData.nodes ? generateData.nodes.length : 0;
        showAlert('success', `ðŸŽ‰ Successfully added provider! Generated ${nodeCount} workflow nodes. Redirecting to home...`);
        
        // Reset form
        uploadForm.reset();
        removeFile();
        
        // Redirect after 2 seconds
        setTimeout(() => {
            window.location.href = '/';
        }, 2000);
        
    } catch (error) {
        console.error('Error:', error);
        showAlert('error', error.message || 'An error occurred during upload');
        progressContainer.style.display = 'none';
        updateStep(1);
    } finally {
        submitBtn.disabled = false;
        loadingState.style.display = 'none';
    }
});
</script>
{% endblock %}